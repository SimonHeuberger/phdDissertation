---
title: "Balance Tests"
author: "Simon Heuberger"
date: "12/13/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(RItools)
library(stargazer)
library(here)
library(tidyverse)
library(magrittr)
library(xtable)
```



```{r include=FALSE}
df <- read.csv(here("data", "experiment", "an.clean.csv"), as.is = TRUE)

cols.fac <- c("educ", "race", "gender", "empl", "inc", "pid", "ideol")
for (i in 1:length(cols.fac)){
    df[,cols.fac[i]] <- factor(df[,cols.fac[i]])
}

df$hc.group.num <- df$hc.group %>% as.factor %>% as.numeric
hc.balance <- xBalance(hc.group.num ~ race + gender + empl + inc + pid + educ + age, 
                    data = df, 
                    report = c("std.diffs", "z.scores", "adj.means", "adj.mean.diffs", 
                               "adj.mean.diffs.null.sd", "chisquare.test", "p.values"))
hc.balance.list <- lapply(seq(dim(hc.balance$results)[3]), function(x) hc.balance$results[ , , x])
hc.balance.df <- plyr::ldply(hc.balance.list, data.frame, .id = NULL)
hc.balance.df$vars <- c(c("White", "Black", "Hispanic", "Asian", "Arab", "Indian", "Hawaiian", "Other"), 
                     paste0("gender", levels(df$gender)), 
                     paste0("empl", levels(df$empl)), paste0("inc", levels(df$inc)), 
                     paste0("pid", levels(df$pid)), paste0("educ", levels(df$educ)), 
                     "age")
hc.balance.df <- hc.balance.df[, c(8,1:7)]

```

```{r include=FALSE}

df$ev.group.num <- df$ev.group %>% as.factor %>% as.numeric
ev.balance <- xBalance(ev.group.num ~ race + gender + empl + inc + pid + educ + age, 
                    data = df, 
                    report = c("std.diffs", "z.scores", "adj.means", "adj.mean.diffs", 
                               "adj.mean.diffs.null.sd", "chisquare.test", "p.values"))
ev.balance.list <- lapply(seq(dim(ev.balance$results)[3]), function(x) ev.balance$results[ , , x])
ev.balance.df <- plyr::ldply(ev.balance.list, data.frame, .id = NULL)
ev.balance.df$vars <- c(c("White", "Black", "Hispanic", "Asian", "Arab", "Indian", "Hawaiian", "Other"), 
                     paste0("gender", levels(df$gender)), 
                     paste0("empl", levels(df$empl)), paste0("inc", levels(df$inc)), 
                     paste0("pid", levels(df$pid)), paste0("educ", levels(df$educ)), 
                     "age")
ev.balance.df <- ev.balance.df[, c(8,1:7)]

```


```{r Count, include = TRUE}
group_by(df, hc.group) %>% summarize(count = n())
group_by(df, ev.group) %>% summarize(count = n())

```

\clearpage

\begin{verbatim}
group.num ~ race + gender + empl + inc + pid + educ + age, data = df.first.omit, 
    report = c("std.diffs", "z.scores", "adj.means", "adj.mean.diffs", 
    "adj.mean.diffs.null.sd", "chisquare.test", "p.values")
\end{verbatim}                               
                              

```{r Balance, results='asis', echo=FALSE, message=FALSE}
xtable(hc.balance.df, caption = "Balance Across Covariates") %>% print(., comment=FALSE, include.rownames=FALSE)
xtable(hc.balance$overall, caption = "Chi-squared test") %>% print(., comment = FALSE, include.rownames=FALSE)

xtable(ev.balance.df, caption = "Balance Across Covariates") %>% print(., comment=FALSE, include.rownames=FALSE)
xtable(ev.balance$overall, caption = "Chi-squared test") %>% print(., comment = FALSE, include.rownames=FALSE)
```

\clearpage


```{r Plot-Balance, echo=FALSE, fig.width=10, fig.height=6, fig.cap="Balance Plot"}
plot(hc.balance)
plot(ev.balance)
```



